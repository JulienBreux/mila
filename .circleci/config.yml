version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.11.3
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install Go task
          command: |
            mkdir /go/bin/task
            curl -s https://taskfile.org/install.sh | sh -s -- -d -b "/go/bin/task"
      - run:
          name: Building Docker image
          command: /go/bin/task/task docker:build
      - run:
          name: Archiving Docker image
          command: /go/bin/task/task docker:save
      - save_cache:
          name: Caching Docker image
          key: docker-image-{{ .Branch }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - /ci/
  release:
    docker:
      - image: circleci/golang:1.11.3
    steps:
      - checkout
      - run:
          name: Release
          command: curl -sL http://git.io/goreleaser | bash
  register:
    docker:
      - image: circleci/golang:1.11.3
    steps:
      - checkout
      - setup_remote_docker
      - restore_cache:
          name: Restoring Docker image
          key: docker-image-{{ .Branch }}-{{ .Environment.CIRCLE_TAG }}
      - run:
          name: Install Go task
          command: |
            mkdir /go/bin/task
            curl -s https://taskfile.org/install.sh | sh -s -- -d -b "/go/bin/task"
      - run:
          name: Unarchiving
          command: /go/bin/task/task docker:load
      - run:
          name: Push images to Docker hub
          command: /go/bin/task/task docker:push
workflows:
  version: 2
  default:
    jobs:
      - build:
          filters:
            tags:
              only: /^v.*/
      - release:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - register:
          requires:
            - build
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - build
